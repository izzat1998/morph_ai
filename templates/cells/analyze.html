{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Analyze {{ cell.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Morphometric Analysis - {{ cell.name }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Image Preview</h5>
                            
                            <!-- ROI Selection Canvas (hidden by default) -->
                            <div id="roi-container" style="display: none;">
                                <div class="mb-3">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="add-roi-btn">
                                            <i class="fas fa-plus"></i> Add Region
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clear-roi-btn">
                                            <i class="fas fa-eraser"></i> Clear All
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        <strong><span id="roi-count">0</span> region(s) selected.</strong> 
                                        <br>üìù Instructions: Click "Add Region", then click and drag to draw rectangles around areas with cells.
                                    </small>
                                </div>
                                <div class="position-relative" style="display: inline-block;">
                                    <canvas id="roi-canvas" style="border: 2px solid #007bff; cursor: default; border-radius: 4px;"></canvas>
                                    <img id="cell-image" src="{{ cell.image.url }}" style="display: none;" alt="{{ cell.name }}">
                                    <div id="roi-status" style="position: absolute; top: 5px; left: 5px; background: rgba(0,123,255,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; display: none;">
                                        Click and drag to draw rectangle
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Regular Image Display -->
                            <div id="regular-image">
                                <img src="{{ cell.image.url }}" class="img-fluid rounded mb-3" alt="{{ cell.name }}">
                            </div>
                            
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>Image Information</h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><strong>Dimensions:</strong> {{ cell.image_width }}√ó{{ cell.image_height }} px</li>
                                        <li><strong>Format:</strong> {{ cell.file_format|upper }}</li>
                                        <li><strong>File Size:</strong> {{ cell.file_size|filesizeformat }}</li>
                                        {% if cell.scale_set %}
                                        <li><strong>Scale:</strong> {{ cell.pixels_per_micron|floatformat:2 }} px/Œºm</li>
                                        {% else %}
                                        <li><strong>Scale:</strong> <span class="text-muted">Not calibrated</span> 
                                            <a href="{% url 'cells:set_scale_calibration' cell.id %}" class="btn btn-sm btn-outline-primary ms-2">
                                                <i class="fas fa-ruler"></i> Set Scale
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Analysis Configuration</h5>
                            
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> About Cellpose Analysis</h6>
                                <p class="mb-0">This analysis will use Cellpose to automatically segment individual cells and extract morphometric features including area, perimeter, circularity, and shape descriptors.</p>
                            </div>
                            
                            {% crispy form %}
                            
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Parameter Guide</h6>
                                </div>
                                <div class="card-body">
                                    <small>
                                        <ul class="mb-0">
                                            <li><strong>Cytoplasm:</strong> Best for cytoplasmic staining</li>
                                            <li><strong>Nuclei:</strong> Best for nuclear staining</li>
                                            <li><strong>Cytoplasm 2.0:</strong> Improved cytoplasm model</li>
                                            <li><strong>Diameter:</strong> Set to 0 for automatic detection</li>
                                            <li><strong>Flow Threshold:</strong> Lower values detect more cells</li>
                                        </ul>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if cell.analyses.exists %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Previous Analyses</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Model</th>
                                    <th>Diameter</th>
                                    <th>Cells Found</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in cell.analyses.all|slice:":5" %}
                                <tr>
                                    <td>{{ analysis.analysis_date|date:"M d, H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{% if analysis.status == 'completed' %}success{% elif analysis.status == 'failed' %}danger{% elif analysis.status == 'processing' %}warning{% else %}secondary{% endif %}">
                                            {{ analysis.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ analysis.get_cellpose_model_display }}</td>
                                    <td>{{ analysis.cellpose_diameter|floatformat:1 }}</td>
                                    <td>{{ analysis.num_cells_detected|default:"-" }}</td>
                                    <td>
                                        {% if analysis.status == 'completed' %}
                                        <a href="{% url 'cells:analysis_detail' analysis.id %}" class="btn btn-xs btn-outline-primary">View</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if cell.analyses.count > 5 %}
                    <p class="text-muted"><small>Showing 5 most recent analyses. <a href="{% url 'cells:cell_detail' cell.id %}">View all</a></small></p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% block extra_js %}
<script>
(function() {
    // Encapsulate all ROI functionality to avoid variable conflicts
    let roiCanvas, roiCtx, cellImg;
    let roiRegions = [];
    let isDrawing = false;
    let startX, startY, currentX, currentY;
    let isAddingROI = false;

document.addEventListener('DOMContentLoaded', function() {
    // Find the analysis form specifically (not the language form)
    const form = document.querySelector('form:not([action*="setlang"])') || document.querySelector('form[method="post"]:not([action*="setlang"])');
    const submitBtn = form?.querySelector('input[type="submit"]') || form?.querySelector('button[type="submit"]');
    
    console.log('=== ROI INITIALIZATION ===');
    console.log('Form found:', form);
    console.log('Submit button found:', submitBtn);
    console.log('Form action:', form?.action);
    console.log('Form method:', form?.method);
    
    if (!form || !submitBtn) {
        console.error('ERROR: Could not find analysis form or submit button!');
        return;
    }
    
    if (form.action.includes('setlang')) {
        console.error('ERROR: Found language form instead of analysis form!');
        return;
    }
    const useROICheckbox = document.getElementById('id_use_roi');
    const roiContainer = document.getElementById('roi-container');
    const regularImage = document.getElementById('regular-image');
    const addROIBtn = document.getElementById('add-roi-btn');
    const clearROIBtn = document.getElementById('clear-roi-btn');
    
    // Initialize canvas
    roiCanvas = document.getElementById('roi-canvas');
    if (roiCanvas) {
        roiCtx = roiCanvas.getContext('2d');
        cellImg = document.getElementById('cell-image');
        
        // Setup canvas when image loads
        cellImg.onload = function() {
            setupCanvas();
        };
        
        // If image is already loaded
        if (cellImg.complete) {
            setupCanvas();
        }
    }
    
    // Toggle ROI interface
    if (useROICheckbox) {
        useROICheckbox.addEventListener('change', function() {
            if (this.checked) {
                roiContainer.style.display = 'block';
                regularImage.style.display = 'none';
            } else {
                roiContainer.style.display = 'none';
                regularImage.style.display = 'block';
                roiRegions = [];
                updateROICount();
            }
        });
    }
    
    // ROI controls
    if (addROIBtn) {
        addROIBtn.addEventListener('click', function() {
            isAddingROI = true;
            this.classList.add('active');
            roiCanvas.style.cursor = 'crosshair';
            document.getElementById('roi-status').style.display = 'block';
        });
    }
    
    if (clearROIBtn) {
        clearROIBtn.addEventListener('click', function() {
            roiRegions = [];
            isAddingROI = false;
            addROIBtn.classList.remove('active');
            roiCanvas.style.cursor = 'default';
            redrawCanvas();
            updateROICount();
        });
    }
    
    // Canvas mouse events
    if (roiCanvas) {
        roiCanvas.addEventListener('mousedown', startDrawing);
        roiCanvas.addEventListener('mousemove', draw);
        roiCanvas.addEventListener('mouseup', stopDrawing);
    }
    
    // Form submission - only add if we have the right form
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
        // Add ROI data to form if ROI is enabled
        console.log('=== FORM SUBMISSION EVENT TRIGGERED ===');
        console.log('Form submission - ROI checkbox checked:', useROICheckbox?.checked);
        console.log('Form submission - ROI regions count:', roiRegions.length);
        console.log('Form submission - ROI regions data:', roiRegions);
        console.log('Form element:', form);
        console.log('Current form data before adding ROI:');
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        if (useROICheckbox && useROICheckbox.checked && roiRegions.length > 0) {
            console.log('ADDING ROI DATA TO FORM - ROI regions:', roiRegions);
            
            // Create hidden input for ROI data
            const roiInput = document.createElement('input');
            roiInput.type = 'hidden';
            roiInput.name = 'roi_data';
            roiInput.value = JSON.stringify(roiRegions);
            form.appendChild(roiInput);
            
            const roiCountInput = document.createElement('input');
            roiCountInput.type = 'hidden';
            roiCountInput.name = 'roi_count';
            roiCountInput.value = roiRegions.length;
            form.appendChild(roiCountInput);
            
            console.log('ROI data added to form successfully');
            
            // Verify the data was actually added
            const newFormData = new FormData(form);
            console.log('Form data AFTER adding ROI:');
            for (let [key, value] of newFormData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
        } else if (useROICheckbox && useROICheckbox.checked) {
            // Show warning and prevent submission
            alert('‚ö†Ô∏è ROI selection is enabled but no regions were drawn.\n\nPlease:\n1. Click "Add Region" button\n2. Draw rectangles around cell areas\n3. Or uncheck "Use ROI Selection" to analyze the whole image');
            e.preventDefault();
            submitBtn.disabled = false;
            submitBtn.value = 'Start Analysis';
            return false;
        }
        
        submitBtn.disabled = true;
        submitBtn.value = 'Processing...';
        
        // Show processing message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning mt-3';
        alertDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analysis is running. This may take a few minutes...';
        form.appendChild(alertDiv);
        });
    }
});

function setupCanvas() {
    // Scale image to fit in reasonable size
    const maxWidth = 500;
    const maxHeight = 400;
    let width = cellImg.naturalWidth;
    let height = cellImg.naturalHeight;
    
    if (width > maxWidth || height > maxHeight) {
        const ratio = Math.min(maxWidth / width, maxHeight / height);
        width *= ratio;
        height *= ratio;
    }
    
    roiCanvas.width = width;
    roiCanvas.height = height;
    
    redrawCanvas();
}

function startDrawing(e) {
    if (!isAddingROI) return;
    
    isDrawing = true;
    const rect = roiCanvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    currentX = startX;
    currentY = startY;
}

function draw(e) {
    if (!isDrawing || !isAddingROI) return;
    
    const rect = roiCanvas.getBoundingClientRect();
    currentX = e.clientX - rect.left;
    currentY = e.clientY - rect.top;
    
    redrawCanvas();
    
    // Draw current rectangle
    roiCtx.strokeStyle = '#ff0000';
    roiCtx.lineWidth = 2;
    roiCtx.setLineDash([5, 5]);
    roiCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    roiCtx.setLineDash([]);
}

function stopDrawing() {
    if (!isDrawing || !isAddingROI) return;
    
    isDrawing = false;
    
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    
    if (width > 10 && height > 10) { // Minimum size check
        // Scale coordinates to original image size
        const scaleX = cellImg.naturalWidth / roiCanvas.width;
        const scaleY = cellImg.naturalHeight / roiCanvas.height;
        
        const roi = {
            x: Math.min(startX, currentX) * scaleX,
            y: Math.min(startY, currentY) * scaleY,
            width: width * scaleX,
            height: height * scaleY
        };
        
        roiRegions.push(roi);
        console.log('ROI added:', roi);
        console.log('Total ROI regions:', roiRegions);
        updateROICount();
    }
    
    isAddingROI = false;
    document.getElementById('add-roi-btn').classList.remove('active');
    roiCanvas.style.cursor = 'default';
    document.getElementById('roi-status').style.display = 'none';
    redrawCanvas();
}

function redrawCanvas() {
    roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
    roiCtx.drawImage(cellImg, 0, 0, roiCanvas.width, roiCanvas.height);
    
    // Draw existing ROI regions
    roiCtx.strokeStyle = '#007bff';
    roiCtx.lineWidth = 2;
    roiCtx.fillStyle = 'rgba(0, 123, 255, 0.1)';
    
    const scaleX = roiCanvas.width / cellImg.naturalWidth;
    const scaleY = roiCanvas.height / cellImg.naturalHeight;
    
    roiRegions.forEach((roi, index) => {
        const x = roi.x * scaleX;
        const y = roi.y * scaleY;
        const w = roi.width * scaleX;
        const h = roi.height * scaleY;
        
        roiCtx.fillRect(x, y, w, h);
        roiCtx.strokeRect(x, y, w, h);
        
        // Draw region number
        roiCtx.fillStyle = '#007bff';
        roiCtx.font = '14px Arial';
        roiCtx.fillText((index + 1).toString(), x + 5, y + 20);
        roiCtx.fillStyle = 'rgba(0, 123, 255, 0.1)';
    });
}

function updateROICount() {
    const countElement = document.getElementById('roi-count');
    if (countElement) {
        countElement.textContent = roiRegions.length;
    }
}

})(); // End of encapsulating function
</script>
{% endblock %}
{% endblock %}