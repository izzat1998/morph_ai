{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Анализировать {{ cell.name }}{% endblock %}

{% block content %}
<!-- Hero Section with Cell Info -->
<section class="container-fluid py-4" style="background: linear-gradient(135deg, var(--lighter-gray) 0%, var(--white) 100%);">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="{% url 'cells:list' %}">Изображения</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'cells:cell_detail' cell.id %}">{{ cell.name }}</a></li>
                        <li class="breadcrumb-item active">Анализировать</li>
                    </ol>
                </nav>
                <h1 class="display-6 fw-bold text-gradient mb-2">Морфометрический анализ</h1>
                <p class="lead text-muted mb-0">{{ cell.name }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex flex-column align-items-md-end">
                    <div class="badge bg-primary-subtle text-primary px-3 py-2 mb-2">
                        <i class="fas fa-microscope me-2"></i>
                        {{ cell.image_width }}×{{ cell.image_height }} px
                    </div>
                    {% if cell.scale_set %}
                    <small class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Масштаб откалиброван: {{ cell.pixels_per_micron|floatformat:2 }} px/μm
                    </small>
                    {% else %}
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Масштаб не откалиброван
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Analysis Content -->
<section class="container-fluid py-4">
    <div class="container-fluid px-4">
        <div class="row g-4">
            <!-- Image Preview Panel -->
            <div class="col-xl-6 col-lg-12">
                <div class="card border-0 shadow-lg h-100">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-image me-2"></i>
                                Предварительный просмотр изображения
                            </h5>
                            <div class="roi-mode-indicator" id="roi-mode-indicator" style="display: none;">
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-crop me-1"></i>
                                    Режим ROI активен
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <!-- ROI Selection Interface (hidden by default) -->
                        <div id="roi-container" class="d-none">
                            <div class="roi-controls mb-4 p-3 bg-light rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="btn-group me-3" role="group">
                                            <button type="button" class="btn btn-primary" id="add-roi-btn">
                                                <i class="fas fa-plus me-2"></i>Добавить регион
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="clear-roi-btn">
                                                <i class="fas fa-eraser me-2"></i>Очистить все
                                            </button>
                                            <button type="button" class="btn btn-outline-info" id="zoom-fit-btn">
                                                <i class="fas fa-search-minus me-2"></i>Подогнать к экрану
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <div class="roi-counter">
                                            <span class="badge bg-success fs-6 px-3 py-2">
                                                <i class="fas fa-vector-square me-2"></i>
                                                <span id="roi-count">0</span> Регионы
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="roi-instructions mt-3 p-3 border-start border-primary border-4 bg-white">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Инструкции ROI
                                    </h6>
                                    <ol class="mb-0 small">
                                        <li>Нажмите "Добавить регион" для включения режима рисования</li>
                                        <li>Нажмите и перетащите для рисования прямоугольников вокруг областей клеток</li>
                                        <li>Можно выбрать несколько регионов для анализа</li>
                                        <li>Используйте "Очистить все" для удаления всех регионов</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <!-- Canvas Container with proper layering -->
                            <div class="image-container position-relative d-flex justify-content-center">
                                <div class="canvas-wrapper position-relative">
                                    <canvas id="roi-canvas" class="border border-2 border-primary rounded shadow-sm"></canvas>
                                    <div id="roi-status" class="position-absolute top-0 start-0 bg-primary text-white px-2 py-1 rounded-bottom-end small d-none" style="z-index: 10;">
                                        <i class="fas fa-crosshairs me-1"></i>
                                        Нажмите и перетащите для рисования прямоугольника
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Regular Image Display -->
                        <div id="regular-image" class="text-center">
                            <div class="image-container position-relative d-inline-block">
                                <img src="{{ cell.image.url }}" class="img-fluid rounded shadow" alt="{{ cell.name }}" style="max-height: 500px;">
                                <div class="image-overlay position-absolute top-0 end-0 m-2">
                                    <button class="btn btn-sm btn-outline-light" onclick="toggleImageFullscreen(this.previousElementSibling)" title="Переключить полноэкранный режим">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Information Footer -->
                    <div class="card-footer bg-light">
                        <div class="row g-3 text-center">
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-primary mb-1">
                                        <i class="fas fa-ruler-combined"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.image_width }}×{{ cell.image_height }}</div>
                                    <div class="info-label small text-muted">Размеры</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-success mb-1">
                                        <i class="fas fa-file-image"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.file_format|upper }}</div>
                                    <div class="info-label small text-muted">Формат</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-info mb-1">
                                        <i class="fas fa-weight-hanging"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.file_size|filesizeformat }}</div>
                                    <div class="info-label small text-muted">Размер файла</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    {% if cell.scale_set %}
                                        <div class="info-icon text-success mb-1">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="info-value fw-bold small">{{ cell.pixels_per_micron|floatformat:2 }}</div>
                                        <div class="info-label small text-muted">px/μm</div>
                                    {% else %}
                                        <div class="info-icon text-warning mb-1">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="info-value fw-bold small">Не установлено</div>
                                        <div class="info-label small">
                                            <a href="{% url 'cells:set_scale_calibration' cell.id %}" class="btn btn-xs btn-outline-primary">
                                                <i class="fas fa-ruler me-1"></i>Калибровать
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Analysis Info Panel -->
            <div class="col-xl-6 col-lg-12">
                <div class="card border-0 shadow-lg h-100">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            О анализе Cellpose
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="analysis-icon mb-3">
                                <i class="fas fa-microscope fa-3x text-primary"></i>
                            </div>
                            <h6 class="fw-bold mb-3">Морфометрический анализ на основе ИИ</h6>
                            <p class="text-muted">Этот анализ использует ИИ Cellpose для автоматической сегментации отдельных клеток и извлечения морфометрических характеристик.</p>
                        </div>
                        
                        <div class="features-list">
                            <div class="feature-item d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="small">Автоматическая сегментация клеток</span>
                            </div>
                            <div class="feature-item d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="small">Морфометрические характеристики</span>
                            </div>
                            <div class="feature-item d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="small">Анализ текстуры GLCM</span>
                            </div>
                            <div class="feature-item d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span class="small">Контроль качества</span>
                            </div>
                        </div>
                        
                        <!-- Analysis Status Container (hidden initially) -->
                        <div id="analysis-status" class="d-none mt-4">
                            <div class="alert alert-warning border-0 shadow-sm">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-warning me-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Анализ в процессе</h6>
                                        <small class="text-muted">Это может занять несколько минут в зависимости от размера и сложности изображения...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced Configuration Panel -->
<section class="container-fluid py-4 bg-light">
    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-12">
                <form method="post" class="analysis-form">
                    {% csrf_token %}
                    <div class="card border-0 shadow-lg">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-microscope me-2"></i>
                                Детальная конфигурация анализа
                            </h5>
                        </div>
                        <div class="card-body p-4">
                        <!-- Configuration Dashboard -->
                        <div class="configuration-dashboard">
                            <div class="row g-4">
                                <!-- Core Parameters -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-cogs me-2"></i>
                                                Основные параметры
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold" for="{{ form.cellpose_model.id_for_label }}">Модель Cellpose</label>
                                                {{ form.cellpose_model }}
                                                <small class="text-muted mt-1">Выберите на основе вашего типа окрашивания</small>
                                                {% if form.cellpose_model.errors %}
                                                    <div class="text-danger small mt-1">{{ form.cellpose_model.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold" for="{{ form.cellpose_diameter.id_for_label }}">Диаметр клетки (пиксели)</label>
                                                <div class="input-group">
                                                    {{ form.cellpose_diameter }}
                                                    <button class="btn btn-outline-secondary" type="button" id="auto-diameter-btn">
                                                        <i class="fas fa-magic"></i> Авто
                                                    </button>
                                                </div>
                                                <small class="text-muted mt-1">Установите 0 для автоматического обнаружения</small>
                                                {% if form.cellpose_diameter.errors %}
                                                    <div class="text-danger small mt-1">{{ form.cellpose_diameter.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segmentation Thresholds -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-success mb-3">
                                                <i class="fas fa-sliders-h me-2"></i>
                                                Пороги сегментации
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold" for="{{ form.flow_threshold.id_for_label }}">Порог потока</label>
                                                <div class="range-input-group">
                                                    <input type="range" class="form-range" min="0" max="3" step="0.1" id="flow-threshold-range">
                                                    {{ form.flow_threshold }}
                                                </div>
                                                <div class="threshold-guide mt-2">
                                                    <span class="badge bg-success">Ниже = Больше клеток</span>
                                                    <span class="badge bg-warning">Выше = Меньше клеток</span>
                                                </div>
                                                {% if form.flow_threshold.errors %}
                                                    <div class="text-danger small mt-1">{{ form.flow_threshold.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold" for="{{ form.cellprob_threshold.id_for_label }}">Порог вероятности клетки</label>
                                                <div class="range-input-group">
                                                    <input type="range" class="form-range" min="-6" max="6" step="0.1" id="cellprob-threshold-range">
                                                    {{ form.cellprob_threshold }}
                                                </div>
                                                <div class="threshold-guide mt-2">
                                                    <span class="badge bg-info">Выше = Более чистая сегментация</span>
                                                </div>
                                                {% if form.cellprob_threshold.errors %}
                                                    <div class="text-danger small mt-1">{{ form.cellprob_threshold.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Advanced Analysis Features -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-info mb-3">
                                                <i class="fas fa-microscope me-2"></i>
                                                Расширенные функции
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    {{ form.use_roi }}
                                                    <label class="form-check-label fw-bold" for="{{ form.use_roi.id_for_label }}">
                                                        Интеллектуальный анализ ROI
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">Выбор региона на основе ИИ с картированием плотности</small>
                                                {% if form.use_roi.errors %}
                                                    <div class="text-danger small mt-1">{{ form.use_roi.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="texture-analysis-preview" checked>
                                                    <label class="form-check-label fw-bold" for="texture-analysis-preview">
                                                        Анализ текстуры GLCM
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">12 GLCM + 17 статистических текстурных характеристик</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="quality-assessment-preview" checked>
                                                    <label class="form-check-label fw-bold" for="quality-assessment-preview">
                                                        Оценка качества
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">Автоматическая оценка качества изображения и валидация</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold" for="{{ form.filtering_mode.id_for_label }}">Режим анализа</label>
                                                {{ form.filtering_mode }}
                                                <small class="text-muted mt-1">Фильтрация медицинского уровня с физической валидацией</small>
                                                {% if form.filtering_mode.errors %}
                                                    <div class="text-danger small mt-1">{{ form.filtering_mode.errors.0 }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Processing Pipeline -->
                        <div class="advanced-processing-pipeline mt-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-gradient-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        Расширенный конвейер обработки изображений
                                    </h6>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-4">
                                        <!-- Preprocessing Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-primary mb-3">
                                                    <i class="fas fa-magic me-2"></i>
                                                    Предварительная обработка
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            {{ form.apply_noise_reduction }}
                                                            <label class="form-check-label small fw-bold" for="{{ form.apply_noise_reduction.id_for_label }}">Двустороннее шумоподавление</label>
                                                        </div>
                                                        <small class="text-muted d-block">Шумоподавление с сохранением краев</small>
                                                        <div class="mt-1">
                                                            {{ form.noise_reduction_method }}
                                                        </div>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            {{ form.apply_contrast_enhancement }}
                                                            <label class="form-check-label small fw-bold" for="{{ form.apply_contrast_enhancement.id_for_label }}">Улучшение CLAHE</label>
                                                        </div>
                                                        <small class="text-muted d-block">Адаптивный контраст для микроскопии</small>
                                                        <div class="mt-1">
                                                            {{ form.contrast_method }}
                                                        </div>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            {{ form.apply_sharpening }}
                                                            <label class="form-check-label small fw-bold" for="{{ form.apply_sharpening.id_for_label }}">Маска нерезкости</label>
                                                        </div>
                                                        <small class="text-muted d-block">Улучшение краев</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            {{ form.apply_normalization }}
                                                            <label class="form-check-label small fw-bold" for="{{ form.apply_normalization.id_for_label }}">Z-оценка нормализации</label>
                                                        </div>
                                                        <small class="text-muted d-block">Стандартизация интенсивности</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Texture Analysis Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-success mb-3">
                                                    <i class="fas fa-fingerprint me-2"></i>
                                                    Анализ текстуры
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-highlight mb-3 p-2 bg-light rounded">
                                                        <strong class="text-success">Характеристики GLCM (12)</strong>
                                                        <small class="text-muted d-block">Contrast, Correlation, Energy, Homogeneity, Entropy, Variance, etc.</small>
                                                    </div>
                                                    <div class="feature-highlight mb-3 p-2 bg-light rounded">
                                                        <strong class="text-info">Статистические характеристики (17)</strong>
                                                        <small class="text-muted d-block">Mean, Std, Skewness, Kurtosis, Percentiles, IQR, etc.</small>
                                                    </div>
                                                    <div class="texture-settings">
                                                        <label class="form-label small">Расстояние GLCM</label>
                                                        <input type="range" class="form-range" min="1" max="5" value="1" id="glcm-distance">
                                                        <small class="text-muted">Расстояние пикселей для совместного встречаемости</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Quality Assessment Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-warning mb-3">
                                                    <i class="fas fa-shield-alt me-2"></i>
                                                    Контроль качества
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">Обнаружение размытия</strong>
                                                        <small class="text-muted d-block">Laplacian variance + Tenengrad</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">Оценка контраста</strong>
                                                        <small class="text-muted d-block">RMS, Michelson, Entropy</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">Анализ шума</strong>
                                                        <small class="text-muted d-block">SNR estimation (dB)</small>
                                                    </div>
                                                    <div class="quality-score mt-3 p-2 bg-success bg-opacity-10 rounded">
                                                        <div class="d-flex justify-content-between">
                                                            <span class="small fw-bold">Оценка качества</span>
                                                            <span class="badge bg-success" id="quality-score">85/100</span>
                                                        </div>
                                                        <div class="progress mt-1" style="height: 4px;">
                                                            <div class="progress-bar bg-success" style="width: 85%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Validation Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-danger mb-3">
                                                    <i class="fas fa-check-double me-2"></i>
                                                    Валидация
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="physics-validation" checked>
                                                            <label class="form-check-label small fw-bold">Физическая валидация</label>
                                                        </div>
                                                        <small class="text-muted d-block">Соотношения площадь-периметр</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="outlier-detection" checked>
                                                            <label class="form-check-label small fw-bold">Обнаружение выбросов</label>
                                                        </div>
                                                        <select class="form-select form-select-sm mt-1">
                                                            <option value="iqr">IQR Method</option>
                                                            <option value="zscore">Z-Score Method</option>
                                                            <option value="modified_zscore" selected>Modified Z-Score</option>
                                                        </select>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="watershed-split" checked>
                                                            <label class="form-check-label small fw-bold">Разделение водоразделом</label>
                                                        </div>
                                                        <small class="text-muted d-block">Разделить соприкасающиеся клетки</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Real-time Parameter Preview -->
                        <div class="parameter-preview mt-4 p-3 bg-light rounded">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-eye me-2"></i>
                                Сводка текущей конфигурации
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-primary mb-1">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="model-preview-value">Цитоплазма</div>
                                        <div class="preview-label small text-muted">Модель</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-success mb-1">
                                            <i class="fas fa-ruler-combined"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="diameter-preview-value">30.0 px</div>
                                        <div class="preview-label small text-muted">Диаметр</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-warning mb-1">
                                            <i class="fas fa-stream"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="flow-preview-value">0.4</div>
                                        <div class="preview-label small text-muted">Порог потока</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-info mb-1">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="cellprob-preview-value">0.0</div>
                                        <div class="preview-label small text-muted">Вероятность клетки</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-success mb-1">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="texture-preview-value">29</div>
                                        <div class="preview-label small text-muted">Текстурные характеристики</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-danger mb-1">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="validation-preview-value">Clinical</div>
                                        <div class="preview-label small text-muted">Валидация</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden preprocessing toggle field -->
                        <div style="display: none;">
                            {{ form.apply_preprocessing }}
                        </div>
                        
                        <!-- Submit Section -->
                        <div class="mt-4 p-4 bg-light rounded">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-2 text-primary">
                                        <i class="fas fa-play-circle me-2"></i>
                                        Готов к запуску анализа?
                                    </h6>
                                    <p class="text-muted mb-0 small">Убедитесь, что все параметры настроены правильно. Анализ может занять несколько минут.</p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <button type="submit" class="btn btn-primary btn-lg px-4 py-2">
                                        <i class="fas fa-microscope me-2"></i>
                                        Запустить анализ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Previous Analyses Section -->
{% if cell.analyses.exists %}
<section class="container-fluid py-4">
    <div class="container">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Предыдущие анализы
                    </h5>
                    <span class="badge bg-light text-dark">
                        {{ cell.analyses.count }} Всего
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-4">Дата</th>
                                <th>Статус</th>
                                <th>Модель</th>
                                <th>Диаметр</th>
                                <th class="text-center">Найдено клеток</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in cell.analyses.all|slice:":5" %}
                            <tr>
                                <td class="px-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt text-muted me-2"></i>
                                        <div>
                                            <div class="fw-bold">{{ analysis.analysis_date|date:"M d, Y" }}</div>
                                            <small class="text-muted">{{ analysis.analysis_date|date:"H:i" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{% if analysis.status == 'completed' %}success{% elif analysis.status == 'failed' %}danger{% elif analysis.status == 'processing' %}warning{% else %}secondary{% endif %} px-3 py-2">
                                        {% if analysis.status == 'completed' %}
                                            <i class="fas fa-check-circle me-1"></i>
                                        {% elif analysis.status == 'failed' %}
                                            <i class="fas fa-times-circle me-1"></i>
                                        {% elif analysis.status == 'processing' %}
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                        {% else %}
                                            <i class="fas fa-clock me-1"></i>
                                        {% endif %}
                                        {{ analysis.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary px-2 py-1">
                                        {{ analysis.get_cellpose_model_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="font-monospace">{{ analysis.cellpose_diameter|floatformat:1 }} px</span>
                                </td>
                                <td class="text-center">
                                    {% if analysis.num_cells_detected %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-dot-circle me-1"></i>
                                            {{ analysis.num_cells_detected }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if analysis.status == 'completed' %}
                                        <a href="{% url 'cells:analysis_detail' analysis.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>
                                            Просмотр
                                        </a>
                                    {% elif analysis.status == 'processing' %}
                                        <span class="text-muted small">
                                            <i class="fas fa-clock me-1"></i>
                                            В процессе...
                                        </span>
                                    {% elif analysis.status == 'failed' %}
                                        <span class="text-danger small">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Не удалось
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if cell.analyses.count > 5 %}
                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        Показано 5 последних анализов. 
                        <a href="{% url 'cells:cell_detail' cell.id %}" class="text-decoration-none">
                            Посмотреть все ({{ cell.analyses.count }})
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Enhanced Configuration Styles -->
<style>
.configuration-dashboard {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
}

.config-section {
    height: 100%;
}

.parameter-card {
    background: white;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef !important;
}

.parameter-card:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
    transform: translateY(-1px);
}

.range-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.range-input-group .form-range {
    flex: 1;
}

.range-input-group .form-control-sm {
    width: 80px;
    flex-shrink: 0;
}

.threshold-guide {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.threshold-guide .badge {
    font-size: 0.75em;
}

.parameter-preview {
    border: 2px dashed #dee2e6;
    background: linear-gradient(45deg, #f8f9fa 0%, #ffffff 100%);
}

.preview-item {
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.preview-item:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.preview-icon {
    font-size: 1.5rem;
}

.preview-value {
    font-size: 1.1rem;
    color: #495057;
}

.section-header h6 {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Enhanced form field styling */
.parameter-card .form-label {
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.parameter-card .form-control,
.parameter-card .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
}

.parameter-card .form-control:focus,
.parameter-card .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Range input styling */
.form-range::-webkit-slider-thumb {
    background: #0d6efd;
    border: 2px solid #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.form-range::-moz-range-thumb {
    background: #0d6efd;
    border: 2px solid #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Auto diameter button */
#auto-diameter-btn {
    transition: all 0.2s ease;
}

#auto-diameter-btn:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .configuration-dashboard .row > div {
        margin-bottom: 1.5rem;
    }
    
    .parameter-preview .row > div {
        margin-bottom: 1rem;
    }
    
    .threshold-guide {
        justify-content: center;
    }
}

/* Animation for parameter updates */
.preview-value {
    transition: all 0.3s ease;
}

.preview-value.updating {
    transform: scale(1.1);
    color: #0d6efd;
    font-weight: bold;
}

/* Advanced processing pipeline styles */
.advanced-processing-pipeline {
    margin-top: 2rem;
}

.processing-module {
    height: 100%;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.processing-module:hover {
    border-color: #dee2e6;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.processing-module h6 {
    font-weight: 600;
    border-bottom: 2px solid;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.feature-list {
    min-height: 200px;
}

.feature-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.feature-item:last-child {
    border-bottom: none;
}

.feature-highlight {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 4px solid #2196f3;
    transition: all 0.2s ease;
}

.feature-highlight:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
}

.texture-settings {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
}

.quality-score {
    border: 1px solid #d4edda;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.quality-score .progress {
    background-color: rgba(255, 255, 255, 0.3);
}

/* Form controls in processing modules */
.processing-module .form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.processing-module .form-select-sm {
    font-size: 0.775rem;
}

.processing-module .form-range {
    margin: 0.5rem 0;
}

/* Responsive adjustments for processing pipeline */
@media (max-width: 992px) {
    .processing-module {
        margin-bottom: 1rem;
    }
    
    .feature-list {
        min-height: auto;
    }
}

/* Enhanced parameter preview for 6 columns */
.parameter-preview .col-md-2 {
    flex: 0 0 16.666667%;
    max-width: 16.666667%;
}

@media (max-width: 768px) {
    .parameter-preview .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 0.5rem;
    }
}

/* Module color coding */
.processing-module:nth-child(1) h6 {
    border-color: #0d6efd;
}

.processing-module:nth-child(2) h6 {
    border-color: #198754;
}

.processing-module:nth-child(3) h6 {
    border-color: #ffc107;
}

.processing-module:nth-child(4) h6 {
    border-color: #dc3545;
}
</style>

{% block extra_js %}
<script>
// Enhanced Configuration Interface
document.addEventListener('DOMContentLoaded', function() {
    initializeConfigurationSync();
    initializeRangeInputs();
    initializePreviewUpdates();
});

function initializeConfigurationSync() {
    // Since we're now using actual form fields directly, no sync needed
    // Just initialize the range inputs to sync with their corresponding number inputs
    initializeRangeInputs();
}

function initializeRangeInputs() {
    // Flow threshold range/input sync
    const flowRange = document.getElementById('flow-threshold-range');
    const flowInput = document.getElementById('flow-threshold-input');
    const flowActual = document.getElementById('id_flow_threshold');
    
    if (flowRange && flowInput && flowActual) {
        function syncFlowThreshold(value) {
            flowRange.value = value;
            flowInput.value = value;
            flowActual.value = value;
            updatePreviewSummary();
        }
        
        flowRange.addEventListener('input', function() {
            syncFlowThreshold(this.value);
        });
        
        flowInput.addEventListener('input', function() {
            syncFlowThreshold(this.value);
        });
    }
    
    // Cell probability threshold range/input sync
    const cellprobRange = document.getElementById('cellprob-threshold-range');
    const cellprobInput = document.getElementById('cellprob-threshold-input');
    const cellprobActual = document.getElementById('id_cellprob_threshold');
    
    if (cellprobRange && cellprobInput && cellprobActual) {
        function syncCellprobThreshold(value) {
            cellprobRange.value = value;
            cellprobInput.value = value;
            cellprobActual.value = value;
            updatePreviewSummary();
        }
        
        cellprobRange.addEventListener('input', function() {
            syncCellprobThreshold(this.value);
        });
        
        cellprobInput.addEventListener('input', function() {
            syncCellprobThreshold(this.value);
        });
    }
    
    // Auto diameter button
    const autoDiameterBtn = document.getElementById('auto-diameter-btn');
    const diameterInput = document.getElementById('id_cellpose_diameter');
    
    if (autoDiameterBtn && diameterInput) {
        autoDiameterBtn.addEventListener('click', function() {
            diameterInput.value = '0';
            updatePreviewSummary();
            
            // Visual feedback
            this.classList.add('btn-success');
            this.innerHTML = '<i class="fas fa-check"></i> Auto';
            setTimeout(() => {
                this.classList.remove('btn-success');
                this.innerHTML = '<i class="fas fa-magic"></i> Auto';
            }, 1500);
        });
    }
}

function initializePreviewUpdates() {
    // Update preview values on page load
    updatePreviewSummary();
    
    // Add event listeners to form fields for real-time preview updates
    const fieldsToWatch = [
        'id_cellpose_model',
        'id_cellpose_diameter', 
        'id_flow_threshold',
        'id_cellprob_threshold'
    ];
    
    fieldsToWatch.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', updatePreviewSummary);
            field.addEventListener('input', updatePreviewSummary);
        }
    });
}

function updatePreviewSummary() {
    // Update model preview
    const modelSelect = document.getElementById('id_cellpose_model');
    const modelPreview = document.getElementById('model-preview-value');
    if (modelSelect && modelPreview) {
        const selectedText = modelSelect.options[modelSelect.selectedIndex].text;
        modelPreview.textContent = selectedText;
    }
    
    // Update diameter preview
    const diameterInput = document.getElementById('id_cellpose_diameter');
    const diameterPreview = document.getElementById('diameter-preview-value');
    if (diameterInput && diameterPreview) {
        const value = parseFloat(diameterInput.value) || 0;
        diameterPreview.textContent = value === 0 ? 'Auto' : value.toFixed(1) + ' px';
    }
    
    // Update flow threshold preview
    const flowInput = document.getElementById('id_flow_threshold');
    const flowPreview = document.getElementById('flow-preview-value');
    if (flowInput && flowPreview) {
        flowPreview.textContent = parseFloat(flowInput.value).toFixed(1);
    }
    
    // Update cell probability preview
    const cellprobInput = document.getElementById('id_cellprob_threshold');
    const cellprobPreview = document.getElementById('cellprob-preview-value');
    if (cellprobInput && cellprobPreview) {
        cellprobPreview.textContent = parseFloat(cellprobInput.value).toFixed(1);
    }
}

// Enhanced ROI Analysis Interface
(function() {
    'use strict';
    
    // State management
    let roiCanvas, roiCtx;
    let roiRegions = [];
    let isDrawing = false;
    let startX, startY, currentX, currentY;
    let isAddingROI = false;
    let canvasScale = 1;
    
    // DOM elements
    let form, submitBtn, useROICheckbox, roiContainer, regularImage;
    let addROIBtn, clearROIBtn, zoomFitBtn, roiModeIndicator;
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeElements();
        initializeROISystem();
        setupEventListeners();
        setupFormHandling();
    });
    
    function initializeElements() {
        // Find form elements
        form = document.querySelector('form:not([action*="setlang"])') || 
               document.querySelector('form[method="post"]:not([action*="setlang"])');
        submitBtn = form?.querySelector('input[type="submit"]') || 
                   form?.querySelector('button[type="submit"]');
        
        // ROI elements
        useROICheckbox = document.getElementById('id_use_roi');
        roiContainer = document.getElementById('roi-container');
        regularImage = document.getElementById('regular-image');
        roiModeIndicator = document.getElementById('roi-mode-indicator');
        
        // Control buttons
        addROIBtn = document.getElementById('add-roi-btn');
        clearROIBtn = document.getElementById('clear-roi-btn');
        zoomFitBtn = document.getElementById('zoom-fit-btn');
        
        // Canvas
        roiCanvas = document.getElementById('roi-canvas');
        
        if (!form || !submitBtn) {
            console.error('Analysis form not found');
            return false;
        }
        
        return true;
    }
    
    function initializeROISystem() {
        if (!roiCanvas) return;
        
        roiCtx = roiCanvas.getContext('2d');
        
        // Create a hidden image for canvas drawing
        const cellImg = new Image();
        cellImg.crossOrigin = 'anonymous';
        cellImg.onload = function() {
            setupCanvas(this);
        };
        cellImg.src = document.querySelector('#regular-image img').src;
    }
    
    function setupCanvas(img) {
        // Calculate optimal canvas size
        const containerWidth = roiContainer.offsetWidth - 100; // Account for padding
        const maxWidth = Math.min(containerWidth, 600);
        const maxHeight = 500;
        
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        
        // Scale to fit container
        if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
        }
        
        canvasScale = width / img.naturalWidth;
        roiCanvas.width = width;
        roiCanvas.height = height;
        
        // Store reference to image
        roiCanvas.sourceImage = img;
        
        redrawCanvas();
    }
    
    function setupEventListeners() {
        // ROI mode toggle
        if (useROICheckbox) {
            useROICheckbox.addEventListener('change', toggleROIMode);
        }
        
        // Control buttons
        if (addROIBtn) {
            addROIBtn.addEventListener('click', enableDrawingMode);
        }
        
        if (clearROIBtn) {
            clearROIBtn.addEventListener('click', clearAllRegions);
        }
        
        if (zoomFitBtn) {
            zoomFitBtn.addEventListener('click', fitToView);
        }
        
        // Canvas interactions
        if (roiCanvas) {
            roiCanvas.addEventListener('mousedown', startDrawing);
            roiCanvas.addEventListener('mousemove', draw);
            roiCanvas.addEventListener('mouseup', stopDrawing);
            roiCanvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch support for mobile
            roiCanvas.addEventListener('touchstart', handleTouch);
            roiCanvas.addEventListener('touchmove', handleTouch);
            roiCanvas.addEventListener('touchend', stopDrawing);
        }
    }
    
    function toggleROIMode() {
        const isROIMode = useROICheckbox.checked;
        
        if (isROIMode) {
            roiContainer.classList.remove('d-none');
            regularImage.style.display = 'none';
            roiModeIndicator.style.display = 'block';
            
            // Setup canvas if not already done
            if (!roiCanvas.sourceImage) {
                initializeROISystem();
            }
        } else {
            roiContainer.classList.add('d-none');
            regularImage.style.display = 'block';
            roiModeIndicator.style.display = 'none';
            clearAllRegions();
        }
        
        // Trigger custom event
        document.dispatchEvent(new CustomEvent('roiModeChanged', {
            detail: { enabled: isROIMode }
        }));
    }
    
    function enableDrawingMode() {
        isAddingROI = true;
        addROIBtn.classList.add('active');
        addROIBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Drawing Mode';
        roiCanvas.style.cursor = 'crosshair';
        
        const statusEl = document.getElementById('roi-status');
        if (statusEl) {
            statusEl.classList.remove('d-none');
        }
    }
    
    function disableDrawingMode() {
        isAddingROI = false;
        addROIBtn.classList.remove('active');
        addROIBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Region';
        roiCanvas.style.cursor = 'default';
        
        const statusEl = document.getElementById('roi-status');
        if (statusEl) {
            statusEl.classList.add('d-none');
        }
    }
    
    function clearAllRegions() {
        roiRegions = [];
        updateROICount();
        disableDrawingMode();
        redrawCanvas();
    }
    
    function fitToView() {
        if (roiCanvas.sourceImage) {
            setupCanvas(roiCanvas.sourceImage);
        }
    }
    
    function getCanvasCoordinates(e) {
        const rect = roiCanvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    function startDrawing(e) {
        if (!isAddingROI) return;
        
        e.preventDefault();
        isDrawing = true;
        
        const coords = getCanvasCoordinates(e);
        startX = coords.x;
        startY = coords.y;
        currentX = startX;
        currentY = startY;
    }
    
    function draw(e) {
        if (!isDrawing || !isAddingROI) return;
        
        e.preventDefault();
        const coords = getCanvasCoordinates(e);
        currentX = coords.x;
        currentY = coords.y;
        
        redrawCanvas();
        
        // Draw current rectangle being drawn
        roiCtx.strokeStyle = '#dc3545';
        roiCtx.lineWidth = 2;
        roiCtx.setLineDash([8, 4]);
        roiCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        roiCtx.setLineDash([]);
    }
    
    function stopDrawing(e) {
        if (!isDrawing || !isAddingROI) return;
        
        isDrawing = false;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        
        // Minimum size validation
        if (width > 15 && height > 15) {
            addROIRegion();
            showRegionAddedFeedback();
        }
        
        disableDrawingMode();
        redrawCanvas();
    }
    
    function addROIRegion() {
        // Scale coordinates to original image size
        const scaleX = roiCanvas.sourceImage.naturalWidth / roiCanvas.width;
        const scaleY = roiCanvas.sourceImage.naturalHeight / roiCanvas.height;
        
        const roi = {
            id: Date.now(),
            x: Math.min(startX, currentX) * scaleX,
            y: Math.min(startY, currentY) * scaleY,
            width: Math.abs(currentX - startX) * scaleX,
            height: Math.abs(currentY - startY) * scaleY
        };
        
        roiRegions.push(roi);
        updateROICount();
        
        console.log('ROI region added:', roi);
    }
    
    function showRegionAddedFeedback() {
        // Visual feedback for region addition
        const feedback = document.createElement('div');
        feedback.className = 'alert alert-success alert-dismissible fade show position-fixed';
        feedback.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        feedback.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Region ${roiRegions.length} added successfully
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            feedback.remove();
        }, 3000);
    }
    
    function redrawCanvas() {
        if (!roiCanvas.sourceImage) return;
        
        roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
        roiCtx.drawImage(roiCanvas.sourceImage, 0, 0, roiCanvas.width, roiCanvas.height);
        
        // Draw existing ROI regions
        roiRegions.forEach((roi, index) => {
            drawROIRegion(roi, index);
        });
    }
    
    function drawROIRegion(roi, index) {
        const x = roi.x * canvasScale;
        const y = roi.y * canvasScale;
        const w = roi.width * canvasScale;
        const h = roi.height * canvasScale;
        
        // Fill
        roiCtx.fillStyle = 'rgba(0, 123, 255, 0.15)';
        roiCtx.fillRect(x, y, w, h);
        
        // Border
        roiCtx.strokeStyle = '#007bff';
        roiCtx.lineWidth = 2;
        roiCtx.strokeRect(x, y, w, h);
        
        // Region label
        roiCtx.fillStyle = '#007bff';
        roiCtx.font = 'bold 14px Arial';
        roiCtx.fillText(`${index + 1}`, x + 5, y + 20);
        
        // Corner handles for visual feedback
        drawCornerHandles(x, y, w, h);
    }
    
    function drawCornerHandles(x, y, w, h) {
        roiCtx.fillStyle = '#007bff';
        const handleSize = 6;
        
        // Corner squares
        roiCtx.fillRect(x - handleSize/2, y - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x + w - handleSize/2, y - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x - handleSize/2, y + h - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x + w - handleSize/2, y + h - handleSize/2, handleSize, handleSize);
    }
    
    function updateROICount() {
        const countElement = document.getElementById('roi-count');
        if (countElement) {
            countElement.textContent = roiRegions.length;
        }
        
        // Update button states
        if (clearROIBtn) {
            clearROIBtn.disabled = roiRegions.length === 0;
        }
    }
    
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type.replace('touch', 'mouse'), {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        roiCanvas.dispatchEvent(mouseEvent);
    }
    
    function setupFormHandling() {
        if (!form || !submitBtn) return;
        
        form.addEventListener('submit', function(e) {
            const analysisStatus = document.getElementById('analysis-status');
            
            // ROI validation
            if (useROICheckbox && useROICheckbox.checked) {
                if (roiRegions.length === 0) {
                    e.preventDefault();
                    showROIValidationError();
                    return false;
                }
                
                // Add ROI data to form
                addROIDataToForm();
            }
            
            // Show full-screen progress overlay
            showProgressOverlay();
            
            // Show processing state
            submitBtn.disabled = true;
            submitBtn.value = 'Processing...';
            
            if (analysisStatus) {
                analysisStatus.classList.remove('d-none');
            }
            
            // Progressive feedback
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.value = 'Analyzing cells...';
                }
            }, 2000);
        });
    }
    
    function showProgressOverlay() {
        const overlay = document.getElementById('progress-overlay');
        if (overlay) {
            overlay.classList.remove('d-none');
            
            // Simulate progress stages
            const stages = [
                { progress: 15, stage: 'Загрузка изображения...', detail: 'Подготовка данных для анализа' },
                { progress: 30, stage: 'Предварительная обработка...', detail: 'Улучшение качества изображения' },
                { progress: 50, stage: 'Сегментация Cellpose...', detail: 'ИИ анализирует клетки' },
                { progress: 70, stage: 'Извлечение характеристик...', detail: 'Измерение морфометрических параметров' },
                { progress: 85, stage: 'Контроль качества...', detail: 'Валидация результатов' },
                { progress: 95, stage: 'Завершение анализа...', detail: 'Генерация отчетов и визуализаций' }
            ];
            
            let currentStage = 0;
            const progressBar = document.getElementById('analysis-progress-bar');
            const stageElement = document.getElementById('progress-stage');
            const detailElement = document.getElementById('progress-detail');
            
            function updateProgress() {
                if (currentStage < stages.length) {
                    const stage = stages[currentStage];
                    
                    if (progressBar) {
                        progressBar.style.width = stage.progress + '%';
                    }
                    
                    if (stageElement) {
                        stageElement.textContent = stage.stage;
                        stageElement.style.animation = 'none';
                        setTimeout(() => {
                            stageElement.style.animation = 'slideInUp 0.5s ease-in-out';
                        }, 10);
                    }
                    
                    if (detailElement) {
                        detailElement.textContent = stage.detail;
                    }
                    
                    currentStage++;
                    
                    // Random interval between 1-3 seconds for realistic feel
                    const nextInterval = Math.random() * 2000 + 1000;
                    setTimeout(updateProgress, nextInterval);
                }
            }
            
            // Start progress simulation after a short delay
            setTimeout(updateProgress, 500);
        }
    }
    
    function addROIDataToForm() {
        // Remove existing ROI inputs
        const existingInputs = form.querySelectorAll('input[name="roi_data"], input[name="roi_count"]');
        existingInputs.forEach(input => input.remove());
        
        // Add new ROI data
        const roiInput = document.createElement('input');
        roiInput.type = 'hidden';
        roiInput.name = 'roi_data';
        roiInput.value = JSON.stringify(roiRegions);
        form.appendChild(roiInput);
        
        const roiCountInput = document.createElement('input');
        roiCountInput.type = 'hidden';
        roiCountInput.name = 'roi_count';
        roiCountInput.value = roiRegions.length;
        form.appendChild(roiCountInput);
        
        console.log(`Added ${roiRegions.length} ROI regions to form`);
    }
    
    function showROIValidationError() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ROI Selection Required
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>ROI selection is enabled but no regions have been drawn.</p>
                        <p><strong>Please either:</strong></p>
                        <ol>
                            <li>Click "Add Region" and draw rectangles around cell areas</li>
                            <li>Or uncheck "Use ROI Selection" to analyze the entire image</li>
                        </ol>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="fas fa-check me-1"></i>
                            Got it
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    }
    
    // Image fullscreen functionality
    window.toggleImageFullscreen = function(img) {
        if (!img) return;
        
        if (img.style.position === 'fixed') {
            // Exit fullscreen
            img.style.cssText = '';
            img.classList.remove('img-fullscreen');
        } else {
            // Enter fullscreen
            img.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                background: rgba(0,0,0,0.9);
                z-index: 9999;
                cursor: zoom-out;
            `;
            img.classList.add('img-fullscreen');
            
            img.addEventListener('click', function() {
                toggleImageFullscreen(this);
            }, { once: true });
        }
    };
    
})();
</script>
{% endblock %}

<!-- Full-Screen Progress Overlay -->
<div id="progress-overlay" class="progress-overlay d-none">
    <div class="progress-content">
        <div class="progress-animation">
            <div class="progress-circle">
                <div class="progress-circle-inner">
                    <i class="fas fa-microscope fa-3x text-white"></i>
                </div>
            </div>
        </div>
        
        <div class="progress-info mt-4">
            <h4 class="text-primary mb-3">Анализ в процессе</h4>
            <div class="progress mb-3" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%" id="analysis-progress-bar"></div>
            </div>
            <p class="progress-stage text-muted mb-2" id="progress-stage">Инициализация анализа...</p>
            <small class="text-muted" id="progress-detail">Подготовка данных для обработки</small>
        </div>
        
        <div class="progress-stats mt-4">
            <div class="row text-center">
                <div class="col-4">
                    <div class="stat-item">
                        <div class="stat-icon text-info mb-2">
                            <i class="fas fa-image fa-2x"></i>
                        </div>
                        <div class="stat-label small text-muted">Обработка изображения</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-item">
                        <div class="stat-icon text-warning mb-2">
                            <i class="fas fa-brain fa-2x"></i>
                        </div>
                        <div class="stat-label small text-muted">ИИ сегментация</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-item">
                        <div class="stat-icon text-success mb-2">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                        <div class="stat-label small text-muted">Анализ характеристик</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-tips mt-4">
            <div class="alert alert-info border-0" style="background: rgba(13, 110, 253, 0.1);">
                <h6 class="alert-heading text-primary">
                    <i class="fas fa-lightbulb me-2"></i>Что происходит?
                </h6>
                <ul class="mb-0 small">
                    <li>Cellpose анализирует ваше изображение с помощью глубокого обучения</li>
                    <li>Каждая клетка сегментируется и измеряется индивидуально</li>
                    <li>Извлекаются морфометрические характеристики и текстурные особенности</li>
                    <li>Результаты проходят контроль качества и валидацию</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Progress Overlay Styles -->
<style>
.progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.95) 0%, rgba(108, 117, 125, 0.95) 100%);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.5s ease-in-out;
}

.progress-content {
    text-align: center;
    max-width: 600px;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.progress-animation {
    position: relative;
    display: inline-block;
}

.progress-circle {
    width: 120px;
    height: 120px;
    border: 4px solid rgba(13, 110, 253, 0.2);
    border-top: 4px solid #0d6efd;
    border-radius: 50%;
    animation: spin 2s linear infinite;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.progress-circle-inner {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #0d6efd 0%, #6c757d 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    animation: pulse 2s ease-in-out infinite;
}

.stat-item {
    padding: 1rem;
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-5px);
}

.stat-icon {
    opacity: 0.6;
    transition: all 0.3s ease;
}

.stat-item:hover .stat-icon {
    opacity: 1;
    transform: scale(1.1);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.05);
        opacity: 0.8;
    }
}

/* Progress stages animation */
.progress-stage {
    animation: slideInUp 0.5s ease-in-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .progress-content {
        margin: 1rem;
        padding: 1.5rem;
        max-width: 90vw;
    }
    
    .progress-circle {
        width: 100px;
        height: 100px;
    }
    
    .progress-circle-inner {
        width: 70px;
        height: 70px;
    }
    
    .progress-circle-inner i {
        font-size: 2rem;
    }
    
    .stat-icon i {
        font-size: 1.5rem !important;
    }
}
</style>

{% endblock %}