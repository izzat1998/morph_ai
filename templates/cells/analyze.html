{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% trans 'Analyze' %} {{ cell.name }}{% endblock %}

{% block content %}
<!-- Hero Section with Cell Info -->
<section class="container-fluid py-4" style="background: linear-gradient(135deg, var(--lighter-gray) 0%, var(--white) 100%);">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="{% url 'cells:list' %}">{% trans 'Images' %}</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'cells:cell_detail' cell.id %}">{{ cell.name }}</a></li>
                        <li class="breadcrumb-item active">{% trans 'Analyze' %}</li>
                    </ol>
                </nav>
                <h1 class="display-6 fw-bold text-gradient mb-2">{% trans 'Morphometric Analysis' %}</h1>
                <p class="lead text-muted mb-0">{{ cell.name }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="d-flex flex-column align-items-md-end">
                    <div class="badge bg-primary-subtle text-primary px-3 py-2 mb-2">
                        <i class="fas fa-microscope me-2"></i>
                        {{ cell.image_width }}×{{ cell.image_height }} px
                    </div>
                    {% if cell.scale_set %}
                    <small class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        {% trans 'Scale calibrated' %}: {{ cell.pixels_per_micron|floatformat:2 }} px/μm
                    </small>
                    {% else %}
                    <small class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% trans 'Scale not calibrated' %}
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Analysis Content -->
<section class="container-fluid py-4">
    <div class="container-fluid px-4">
        <div class="row g-4">
            <!-- Image Preview Panel -->
            <div class="col-xl-6 col-lg-12">
                <div class="card border-0 shadow-lg h-100">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-image me-2"></i>
                                {% trans 'Image Preview' %}
                            </h5>
                            <div class="roi-mode-indicator" id="roi-mode-indicator" style="display: none;">
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-crop me-1"></i>
                                    {% trans 'ROI Mode Active' %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <!-- ROI Selection Interface (hidden by default) -->
                        <div id="roi-container" class="d-none">
                            <div class="roi-controls mb-4 p-3 bg-light rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="btn-group me-3" role="group">
                                            <button type="button" class="btn btn-primary" id="add-roi-btn">
                                                <i class="fas fa-plus me-2"></i>{% trans 'Add Region' %}
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="clear-roi-btn">
                                                <i class="fas fa-eraser me-2"></i>{% trans 'Clear All' %}
                                            </button>
                                            <button type="button" class="btn btn-outline-info" id="zoom-fit-btn">
                                                <i class="fas fa-search-minus me-2"></i>{% trans 'Fit to View' %}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <div class="roi-counter">
                                            <span class="badge bg-success fs-6 px-3 py-2">
                                                <i class="fas fa-vector-square me-2"></i>
                                                <span id="roi-count">0</span> {% trans 'Regions' %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="roi-instructions mt-3 p-3 border-start border-primary border-4 bg-white">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        {% trans 'ROI Instructions' %}
                                    </h6>
                                    <ol class="mb-0 small">
                                        <li>{% trans 'Click "Add Region" to enable drawing mode' %}</li>
                                        <li>{% trans 'Click and drag to draw rectangles around cell areas' %}</li>
                                        <li>{% trans 'Multiple regions can be selected for analysis' %}</li>
                                        <li>{% trans 'Use "Clear All" to remove all regions' %}</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <!-- Canvas Container with proper layering -->
                            <div class="image-container position-relative d-flex justify-content-center">
                                <div class="canvas-wrapper position-relative">
                                    <canvas id="roi-canvas" class="border border-2 border-primary rounded shadow-sm"></canvas>
                                    <div id="roi-status" class="position-absolute top-0 start-0 bg-primary text-white px-2 py-1 rounded-bottom-end small d-none" style="z-index: 10;">
                                        <i class="fas fa-crosshairs me-1"></i>
                                        {% trans 'Click and drag to draw rectangle' %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Regular Image Display -->
                        <div id="regular-image" class="text-center">
                            <div class="image-container position-relative d-inline-block">
                                <img src="{{ cell.image.url }}" class="img-fluid rounded shadow" alt="{{ cell.name }}" style="max-height: 500px;">
                                <div class="image-overlay position-absolute top-0 end-0 m-2">
                                    <button class="btn btn-sm btn-outline-light" onclick="toggleImageFullscreen(this.previousElementSibling)" title="{% trans 'Toggle Fullscreen' %}">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Information Footer -->
                    <div class="card-footer bg-light">
                        <div class="row g-3 text-center">
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-primary mb-1">
                                        <i class="fas fa-ruler-combined"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.image_width }}×{{ cell.image_height }}</div>
                                    <div class="info-label small text-muted">{% trans 'Dimensions' %}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-success mb-1">
                                        <i class="fas fa-file-image"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.file_format|upper }}</div>
                                    <div class="info-label small text-muted">{% trans 'Format' %}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    <div class="info-icon text-info mb-1">
                                        <i class="fas fa-weight-hanging"></i>
                                    </div>
                                    <div class="info-value fw-bold">{{ cell.file_size|filesizeformat }}</div>
                                    <div class="info-label small text-muted">{% trans 'File Size' %}</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="info-item">
                                    {% if cell.scale_set %}
                                        <div class="info-icon text-success mb-1">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="info-value fw-bold small">{{ cell.pixels_per_micron|floatformat:2 }}</div>
                                        <div class="info-label small text-muted">px/μm</div>
                                    {% else %}
                                        <div class="info-icon text-warning mb-1">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="info-value fw-bold small">{% trans 'Not Set' %}</div>
                                        <div class="info-label small">
                                            <a href="{% url 'cells:set_scale_calibration' cell.id %}" class="btn btn-xs btn-outline-primary">
                                                <i class="fas fa-ruler me-1"></i>{% trans 'Calibrate' %}
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Configuration Panel -->
            <div class="col-xl-6 col-lg-12">
                <div class="card border-0 shadow-lg h-100">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            {% trans 'Analysis Configuration' %}
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Analysis Info Alert -->
                        <div class="alert alert-info border-0 shadow-sm mb-4">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle fa-lg text-info"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-2">{% trans 'About Cellpose Analysis' %}</h6>
                                    <p class="mb-0">{% trans 'This analysis will use Cellpose AI to automatically segment individual cells and extract morphometric features including area, perimeter, circularity, and shape descriptors.' %}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Form -->
                        <div class="analysis-form">
                            {% crispy form %}
                        </div>
                        
                        <!-- Analysis Status Container (hidden initially) -->
                        <div id="analysis-status" class="d-none mt-4">
                            <div class="alert alert-warning border-0 shadow-sm">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-warning me-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">{% trans 'Analysis in Progress' %}</h6>
                                        <small class="text-muted">{% trans 'This may take a few minutes depending on image size and complexity...' %}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parameter Guide Footer -->
                    <div class="card-footer bg-light">
                        <div class="accordion accordion-flush" id="parameterGuide">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#parameterGuideContent">
                                        <i class="fas fa-question-circle me-2"></i>
                                        {% trans 'Parameter Guide' %}
                                    </button>
                                </h2>
                                <div id="parameterGuideContent" class="accordion-collapse collapse" data-bs-parent="#parameterGuide">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <div class="parameter-item p-3 border-start border-primary border-3">
                                                    <h6 class="mb-2 text-primary">{% trans 'Model Selection' %}</h6>
                                                    <div class="row g-2">
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong class="text-primary">{% trans 'Cytoplasm' %}</strong><br>
                                                                <small>{% trans 'Best for cytoplasmic staining' %}</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong class="text-success">{% trans 'Nuclei' %}</strong><br>
                                                                <small>{% trans 'Best for nuclear staining' %}</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong class="text-info">{% trans 'Cytoplasm 2.0' %}</strong><br>
                                                                <small>{% trans 'Improved cytoplasm model' %}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="parameter-item p-3 border-start border-success border-3">
                                                    <h6 class="mb-2 text-success">{% trans 'Parameter Guidelines' %}</h6>
                                                    <div class="row g-2">
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong>{% trans 'Diameter' %}</strong><br>
                                                                <small>{% trans 'Set to 0 for automatic detection' %}</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong>{% trans 'Flow Threshold' %}</strong><br>
                                                                <small>{% trans 'Lower values detect more cells' %}</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="p-2 bg-light rounded">
                                                                <strong>{% trans 'Cell Probability' %}</strong><br>
                                                                <small>{% trans 'Higher values for cleaner segmentation' %}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced Configuration Panel -->
<section class="container-fluid py-4 bg-light">
    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-lg">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-microscope me-2"></i>
                            {% trans 'Detailed Analysis Configuration' %}
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Configuration Dashboard -->
                        <div class="configuration-dashboard">
                            <div class="row g-4">
                                <!-- Core Parameters -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-cogs me-2"></i>
                                                {% trans 'Core Parameters' %}
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold">{% trans 'Cellpose Model' %}</label>
                                                <select class="form-select" id="cellpose-model-preview">
                                                    <option value="cyto">{% trans 'Cytoplasm' %}</option>
                                                    <option value="nuclei">{% trans 'Nuclei' %}</option>
                                                    <option value="cyto2">{% trans 'Cytoplasm 2.0' %}</option>
                                                </select>
                                                <small class="text-muted mt-1">{% trans 'Select based on your staining type' %}</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold">{% trans 'Cell Diameter (pixels)' %}</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="diameter-preview" placeholder="30.0" min="0" step="0.1">
                                                    <button class="btn btn-outline-secondary" type="button" id="auto-diameter-btn">
                                                        <i class="fas fa-magic"></i> {% trans 'Auto' %}
                                                    </button>
                                                </div>
                                                <small class="text-muted mt-1">{% trans 'Set to 0 for automatic detection' %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segmentation Thresholds -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-success mb-3">
                                                <i class="fas fa-sliders-h me-2"></i>
                                                {% trans 'Segmentation Thresholds' %}
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold">{% trans 'Flow Threshold' %}</label>
                                                <div class="range-input-group">
                                                    <input type="range" class="form-range" min="0" max="3" step="0.1" value="0.4" id="flow-threshold-range">
                                                    <input type="number" class="form-control form-control-sm" id="flow-threshold-input" value="0.4" min="0" max="3" step="0.1">
                                                </div>
                                                <div class="threshold-guide mt-2">
                                                    <span class="badge bg-success">{% trans 'Lower = More Cells' %}</span>
                                                    <span class="badge bg-warning">{% trans 'Higher = Fewer Cells' %}</span>
                                                </div>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold">{% trans 'Cell Probability Threshold' %}</label>
                                                <div class="range-input-group">
                                                    <input type="range" class="form-range" min="-6" max="6" step="0.1" value="0.0" id="cellprob-threshold-range">
                                                    <input type="number" class="form-control form-control-sm" id="cellprob-threshold-input" value="0.0" min="-6" max="6" step="0.1">
                                                </div>
                                                <div class="threshold-guide mt-2">
                                                    <span class="badge bg-info">{% trans 'Higher = Cleaner Segmentation' %}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Advanced Analysis Features -->
                                <div class="col-lg-4">
                                    <div class="config-section">
                                        <div class="section-header">
                                            <h6 class="text-info mb-3">
                                                <i class="fas fa-microscope me-2"></i>
                                                {% trans 'Advanced Features' %}
                                            </h6>
                                        </div>
                                        <div class="parameters-grid">
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="roi-toggle-preview">
                                                    <label class="form-check-label fw-bold" for="roi-toggle-preview">
                                                        {% trans 'Intelligent ROI Analysis' %}
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">{% trans 'AI-powered region selection with density mapping' %}</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="texture-analysis-preview" checked>
                                                    <label class="form-check-label fw-bold" for="texture-analysis-preview">
                                                        {% trans 'GLCM Texture Analysis' %}
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">{% trans '12 GLCM + 17 statistical texture features' %}</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="quality-assessment-preview" checked>
                                                    <label class="form-check-label fw-bold" for="quality-assessment-preview">
                                                        {% trans 'Quality Assessment' %}
                                                    </label>
                                                </div>
                                                <small class="text-muted mt-1">{% trans 'Automated image quality scoring & validation' %}</small>
                                            </div>
                                            <div class="parameter-card mb-3 p-3 border rounded">
                                                <label class="form-label fw-bold">{% trans 'Analysis Mode' %}</label>
                                                <select class="form-select" id="filtering-mode-preview">
                                                    <option value="none">{% trans 'No Filtering' %}</option>
                                                    <option value="basic">{% trans 'Basic' %}</option>
                                                    <option value="research">{% trans 'Research' %}</option>
                                                    <option value="clinical" selected>{% trans 'Clinical Grade' %}</option>
                                                    <option value="custom">{% trans 'Custom Advanced' %}</option>
                                                </select>
                                                <small class="text-muted mt-1">{% trans 'Medical-grade filtering with physics validation' %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Processing Pipeline -->
                        <div class="advanced-processing-pipeline mt-4">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-gradient-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        {% trans 'Advanced Image Processing Pipeline' %}
                                    </h6>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-4">
                                        <!-- Preprocessing Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-primary mb-3">
                                                    <i class="fas fa-magic me-2"></i>
                                                    {% trans 'Preprocessing' %}
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="noise-reduction-toggle">
                                                            <label class="form-check-label small fw-bold">{% trans 'Bilateral Noise Reduction' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Edge-preserving denoising' %}</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="clahe-toggle">
                                                            <label class="form-check-label small fw-bold">{% trans 'CLAHE Enhancement' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Adaptive contrast for microscopy' %}</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="sharpening-toggle">
                                                            <label class="form-check-label small fw-bold">{% trans 'Unsharp Masking' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Edge enhancement' %}</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="normalization-toggle">
                                                            <label class="form-check-label small fw-bold">{% trans 'Z-Score Normalization' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Intensity standardization' %}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Texture Analysis Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-success mb-3">
                                                    <i class="fas fa-fingerprint me-2"></i>
                                                    {% trans 'Texture Analysis' %}
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-highlight mb-3 p-2 bg-light rounded">
                                                        <strong class="text-success">{% trans 'GLCM Features (12)' %}</strong>
                                                        <small class="text-muted d-block">Contrast, Correlation, Energy, Homogeneity, Entropy, Variance, etc.</small>
                                                    </div>
                                                    <div class="feature-highlight mb-3 p-2 bg-light rounded">
                                                        <strong class="text-info">{% trans 'Statistical Features (17)' %}</strong>
                                                        <small class="text-muted d-block">Mean, Std, Skewness, Kurtosis, Percentiles, IQR, etc.</small>
                                                    </div>
                                                    <div class="texture-settings">
                                                        <label class="form-label small">{% trans 'GLCM Distance' %}</label>
                                                        <input type="range" class="form-range" min="1" max="5" value="1" id="glcm-distance">
                                                        <small class="text-muted">{% trans 'Pixel distance for co-occurrence' %}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Quality Assessment Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-warning mb-3">
                                                    <i class="fas fa-shield-alt me-2"></i>
                                                    {% trans 'Quality Control' %}
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">{% trans 'Blur Detection' %}</strong>
                                                        <small class="text-muted d-block">Laplacian variance + Tenengrad</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">{% trans 'Contrast Assessment' %}</strong>
                                                        <small class="text-muted d-block">RMS, Michelson, Entropy</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <strong class="text-primary small">{% trans 'Noise Analysis' %}</strong>
                                                        <small class="text-muted d-block">SNR estimation (dB)</small>
                                                    </div>
                                                    <div class="quality-score mt-3 p-2 bg-success bg-opacity-10 rounded">
                                                        <div class="d-flex justify-content-between">
                                                            <span class="small fw-bold">{% trans 'Quality Score' %}</span>
                                                            <span class="badge bg-success" id="quality-score">85/100</span>
                                                        </div>
                                                        <div class="progress mt-1" style="height: 4px;">
                                                            <div class="progress-bar bg-success" style="width: 85%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Validation Module -->
                                        <div class="col-lg-3">
                                            <div class="processing-module">
                                                <h6 class="text-danger mb-3">
                                                    <i class="fas fa-check-double me-2"></i>
                                                    {% trans 'Validation' %}
                                                </h6>
                                                <div class="feature-list">
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="physics-validation" checked>
                                                            <label class="form-check-label small fw-bold">{% trans 'Physics Validation' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Area-perimeter relationships' %}</small>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="outlier-detection" checked>
                                                            <label class="form-check-label small fw-bold">{% trans 'Outlier Detection' %}</label>
                                                        </div>
                                                        <select class="form-select form-select-sm mt-1">
                                                            <option value="iqr">IQR Method</option>
                                                            <option value="zscore">Z-Score Method</option>
                                                            <option value="modified_zscore" selected>Modified Z-Score</option>
                                                        </select>
                                                    </div>
                                                    <div class="feature-item mb-2">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="watershed-split" checked>
                                                            <label class="form-check-label small fw-bold">{% trans 'Watershed Splitting' %}</label>
                                                        </div>
                                                        <small class="text-muted d-block">{% trans 'Split touching cells' %}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Real-time Parameter Preview -->
                        <div class="parameter-preview mt-4 p-3 bg-light rounded">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-eye me-2"></i>
                                {% trans 'Current Configuration Summary' %}
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-primary mb-1">
                                            <i class="fas fa-brain"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="model-preview-value">{% trans 'Cytoplasm' %}</div>
                                        <div class="preview-label small text-muted">{% trans 'Model' %}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-success mb-1">
                                            <i class="fas fa-ruler-combined"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="diameter-preview-value">30.0 px</div>
                                        <div class="preview-label small text-muted">{% trans 'Diameter' %}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-warning mb-1">
                                            <i class="fas fa-stream"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="flow-preview-value">0.4</div>
                                        <div class="preview-label small text-muted">{% trans 'Flow Threshold' %}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-info mb-1">
                                            <i class="fas fa-percentage"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="cellprob-preview-value">0.0</div>
                                        <div class="preview-label small text-muted">{% trans 'Cell Probability' %}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-success mb-1">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="texture-preview-value">29</div>
                                        <div class="preview-label small text-muted">{% trans 'Texture Features' %}</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="preview-item text-center p-2 bg-white rounded">
                                        <div class="preview-icon text-danger mb-1">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="preview-value fw-bold" id="validation-preview-value">Clinical</div>
                                        <div class="preview-label small text-muted">{% trans 'Validation' %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Previous Analyses Section -->
{% if cell.analyses.exists %}
<section class="container-fluid py-4">
    <div class="container">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        {% trans 'Previous Analyses' %}
                    </h5>
                    <span class="badge bg-light text-dark">
                        {{ cell.analyses.count }} {% trans 'Total' %}
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-4">{% trans 'Date' %}</th>
                                <th>{% trans 'Status' %}</th>
                                <th>{% trans 'Model' %}</th>
                                <th>{% trans 'Diameter' %}</th>
                                <th class="text-center">{% trans 'Cells Found' %}</th>
                                <th class="text-center">{% trans 'Actions' %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in cell.analyses.all|slice:":5" %}
                            <tr>
                                <td class="px-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt text-muted me-2"></i>
                                        <div>
                                            <div class="fw-bold">{{ analysis.analysis_date|date:"M d, Y" }}</div>
                                            <small class="text-muted">{{ analysis.analysis_date|date:"H:i" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{% if analysis.status == 'completed' %}success{% elif analysis.status == 'failed' %}danger{% elif analysis.status == 'processing' %}warning{% else %}secondary{% endif %} px-3 py-2">
                                        {% if analysis.status == 'completed' %}
                                            <i class="fas fa-check-circle me-1"></i>
                                        {% elif analysis.status == 'failed' %}
                                            <i class="fas fa-times-circle me-1"></i>
                                        {% elif analysis.status == 'processing' %}
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                        {% else %}
                                            <i class="fas fa-clock me-1"></i>
                                        {% endif %}
                                        {{ analysis.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-primary-subtle text-primary px-2 py-1">
                                        {{ analysis.get_cellpose_model_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="font-monospace">{{ analysis.cellpose_diameter|floatformat:1 }} px</span>
                                </td>
                                <td class="text-center">
                                    {% if analysis.num_cells_detected %}
                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                            <i class="fas fa-dot-circle me-1"></i>
                                            {{ analysis.num_cells_detected }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if analysis.status == 'completed' %}
                                        <a href="{% url 'cells:analysis_detail' analysis.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>
                                            {% trans 'View' %}
                                        </a>
                                    {% elif analysis.status == 'processing' %}
                                        <span class="text-muted small">
                                            <i class="fas fa-clock me-1"></i>
                                            {% trans 'In progress...' %}
                                        </span>
                                    {% elif analysis.status == 'failed' %}
                                        <span class="text-danger small">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            {% trans 'Failed' %}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if cell.analyses.count > 5 %}
                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        {% trans 'Showing 5 most recent analyses.' %} 
                        <a href="{% url 'cells:cell_detail' cell.id %}" class="text-decoration-none">
                            {% trans 'View all' %} ({{ cell.analyses.count }})
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Enhanced Configuration Styles -->
<style>
.configuration-dashboard {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
}

.config-section {
    height: 100%;
}

.parameter-card {
    background: white;
    transition: all 0.2s ease;
    border: 1px solid #e9ecef !important;
}

.parameter-card:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
    transform: translateY(-1px);
}

.range-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.range-input-group .form-range {
    flex: 1;
}

.range-input-group .form-control-sm {
    width: 80px;
    flex-shrink: 0;
}

.threshold-guide {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.threshold-guide .badge {
    font-size: 0.75em;
}

.parameter-preview {
    border: 2px dashed #dee2e6;
    background: linear-gradient(45deg, #f8f9fa 0%, #ffffff 100%);
}

.preview-item {
    transition: all 0.2s ease;
    border: 1px solid #e9ecef;
}

.preview-item:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.preview-icon {
    font-size: 1.5rem;
}

.preview-value {
    font-size: 1.1rem;
    color: #495057;
}

.section-header h6 {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Enhanced form field styling */
.parameter-card .form-label {
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.parameter-card .form-control,
.parameter-card .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
}

.parameter-card .form-control:focus,
.parameter-card .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Range input styling */
.form-range::-webkit-slider-thumb {
    background: #0d6efd;
    border: 2px solid #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.form-range::-moz-range-thumb {
    background: #0d6efd;
    border: 2px solid #ffffff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

/* Auto diameter button */
#auto-diameter-btn {
    transition: all 0.2s ease;
}

#auto-diameter-btn:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .configuration-dashboard .row > div {
        margin-bottom: 1.5rem;
    }
    
    .parameter-preview .row > div {
        margin-bottom: 1rem;
    }
    
    .threshold-guide {
        justify-content: center;
    }
}

/* Animation for parameter updates */
.preview-value {
    transition: all 0.3s ease;
}

.preview-value.updating {
    transform: scale(1.1);
    color: #0d6efd;
    font-weight: bold;
}

/* Advanced processing pipeline styles */
.advanced-processing-pipeline {
    margin-top: 2rem;
}

.processing-module {
    height: 100%;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

.processing-module:hover {
    border-color: #dee2e6;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.processing-module h6 {
    font-weight: 600;
    border-bottom: 2px solid;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.feature-list {
    min-height: 200px;
}

.feature-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.feature-item:last-child {
    border-bottom: none;
}

.feature-highlight {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 4px solid #2196f3;
    transition: all 0.2s ease;
}

.feature-highlight:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
}

.texture-settings {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
}

.quality-score {
    border: 1px solid #d4edda;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.quality-score .progress {
    background-color: rgba(255, 255, 255, 0.3);
}

/* Form controls in processing modules */
.processing-module .form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.processing-module .form-select-sm {
    font-size: 0.775rem;
}

.processing-module .form-range {
    margin: 0.5rem 0;
}

/* Responsive adjustments for processing pipeline */
@media (max-width: 992px) {
    .processing-module {
        margin-bottom: 1rem;
    }
    
    .feature-list {
        min-height: auto;
    }
}

/* Enhanced parameter preview for 6 columns */
.parameter-preview .col-md-2 {
    flex: 0 0 16.666667%;
    max-width: 16.666667%;
}

@media (max-width: 768px) {
    .parameter-preview .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 0.5rem;
    }
}

/* Module color coding */
.processing-module:nth-child(1) h6 {
    border-color: #0d6efd;
}

.processing-module:nth-child(2) h6 {
    border-color: #198754;
}

.processing-module:nth-child(3) h6 {
    border-color: #ffc107;
}

.processing-module:nth-child(4) h6 {
    border-color: #dc3545;
}
</style>

{% block extra_js %}
<script>
// Enhanced Configuration Interface
document.addEventListener('DOMContentLoaded', function() {
    initializeConfigurationSync();
    initializeRangeInputs();
    initializePreviewUpdates();
});

function initializeConfigurationSync() {
    // Sync preview controls with actual form fields
    const syncElements = [
        { preview: 'cellpose-model-preview', actual: 'id_cellpose_model' },
        { preview: 'diameter-preview', actual: 'id_cellpose_diameter' },
        { preview: 'flow-threshold-input', actual: 'id_flow_threshold' },
        { preview: 'cellprob-threshold-input', actual: 'id_cellprob_threshold' },
        { preview: 'roi-toggle-preview', actual: 'id_use_roi' },
        { preview: 'filtering-mode-preview', actual: 'id_filtering_mode' }
    ];
    
    syncElements.forEach(({preview, actual}) => {
        const previewEl = document.getElementById(preview);
        const actualEl = document.getElementById(actual);
        
        if (previewEl && actualEl) {
            // Initialize preview with actual value
            if (previewEl.type === 'checkbox') {
                previewEl.checked = actualEl.checked;
            } else {
                previewEl.value = actualEl.value;
            }
            
            // Sync changes from preview to actual
            previewEl.addEventListener('change', function() {
                if (this.type === 'checkbox') {
                    actualEl.checked = this.checked;
                } else {
                    actualEl.value = this.value;
                }
                updatePreviewSummary();
                
                // Trigger any form validation or change events
                actualEl.dispatchEvent(new Event('change'));
            });
            
            // Sync changes from actual to preview
            actualEl.addEventListener('change', function() {
                if (this.type === 'checkbox') {
                    previewEl.checked = this.checked;
                } else {
                    previewEl.value = this.value;
                }
                updatePreviewSummary();
            });
        }
    });
}

function initializeRangeInputs() {
    // Flow threshold range/input sync
    const flowRange = document.getElementById('flow-threshold-range');
    const flowInput = document.getElementById('flow-threshold-input');
    const flowActual = document.getElementById('id_flow_threshold');
    
    if (flowRange && flowInput && flowActual) {
        function syncFlowThreshold(value) {
            flowRange.value = value;
            flowInput.value = value;
            flowActual.value = value;
            updatePreviewSummary();
        }
        
        flowRange.addEventListener('input', function() {
            syncFlowThreshold(this.value);
        });
        
        flowInput.addEventListener('input', function() {
            syncFlowThreshold(this.value);
        });
    }
    
    // Cell probability threshold range/input sync
    const cellprobRange = document.getElementById('cellprob-threshold-range');
    const cellprobInput = document.getElementById('cellprob-threshold-input');
    const cellprobActual = document.getElementById('id_cellprob_threshold');
    
    if (cellprobRange && cellprobInput && cellprobActual) {
        function syncCellprobThreshold(value) {
            cellprobRange.value = value;
            cellprobInput.value = value;
            cellprobActual.value = value;
            updatePreviewSummary();
        }
        
        cellprobRange.addEventListener('input', function() {
            syncCellprobThreshold(this.value);
        });
        
        cellprobInput.addEventListener('input', function() {
            syncCellprobThreshold(this.value);
        });
    }
    
    // Auto diameter button
    const autoDiameterBtn = document.getElementById('auto-diameter-btn');
    const diameterPreview = document.getElementById('diameter-preview');
    const diameterActual = document.getElementById('id_cellpose_diameter');
    
    if (autoDiameterBtn && diameterPreview && diameterActual) {
        autoDiameterBtn.addEventListener('click', function() {
            diameterPreview.value = '0';
            diameterActual.value = '0';
            updatePreviewSummary();
            
            // Visual feedback
            this.classList.add('btn-success');
            this.innerHTML = '<i class="fas fa-check"></i> Auto';
            setTimeout(() => {
                this.classList.remove('btn-success');
                this.innerHTML = '<i class="fas fa-magic"></i> Auto';
            }, 1500);
        });
    }
}

function initializePreviewUpdates() {
    // Update preview values on page load
    updatePreviewSummary();
}

function updatePreviewSummary() {
    // Update model preview
    const modelSelect = document.getElementById('cellpose-model-preview');
    const modelPreview = document.getElementById('model-preview-value');
    if (modelSelect && modelPreview) {
        const selectedText = modelSelect.options[modelSelect.selectedIndex].text;
        modelPreview.textContent = selectedText;
    }
    
    // Update diameter preview
    const diameterInput = document.getElementById('diameter-preview');
    const diameterPreview = document.getElementById('diameter-preview-value');
    if (diameterInput && diameterPreview) {
        const value = parseFloat(diameterInput.value) || 0;
        diameterPreview.textContent = value === 0 ? 'Auto' : value.toFixed(1) + ' px';
    }
    
    // Update flow threshold preview
    const flowInput = document.getElementById('flow-threshold-input');
    const flowPreview = document.getElementById('flow-preview-value');
    if (flowInput && flowPreview) {
        flowPreview.textContent = parseFloat(flowInput.value).toFixed(1);
    }
    
    // Update cell probability preview
    const cellprobInput = document.getElementById('cellprob-threshold-input');
    const cellprobPreview = document.getElementById('cellprob-preview-value');
    if (cellprobInput && cellprobPreview) {
        cellprobPreview.textContent = parseFloat(cellprobInput.value).toFixed(1);
    }
}

// Enhanced ROI Analysis Interface
(function() {
    'use strict';
    
    // State management
    let roiCanvas, roiCtx;
    let roiRegions = [];
    let isDrawing = false;
    let startX, startY, currentX, currentY;
    let isAddingROI = false;
    let canvasScale = 1;
    
    // DOM elements
    let form, submitBtn, useROICheckbox, roiContainer, regularImage;
    let addROIBtn, clearROIBtn, zoomFitBtn, roiModeIndicator;
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeElements();
        initializeROISystem();
        setupEventListeners();
        setupFormHandling();
    });
    
    function initializeElements() {
        // Find form elements
        form = document.querySelector('form:not([action*="setlang"])') || 
               document.querySelector('form[method="post"]:not([action*="setlang"])');
        submitBtn = form?.querySelector('input[type="submit"]') || 
                   form?.querySelector('button[type="submit"]');
        
        // ROI elements
        useROICheckbox = document.getElementById('id_use_roi');
        roiContainer = document.getElementById('roi-container');
        regularImage = document.getElementById('regular-image');
        roiModeIndicator = document.getElementById('roi-mode-indicator');
        
        // Control buttons
        addROIBtn = document.getElementById('add-roi-btn');
        clearROIBtn = document.getElementById('clear-roi-btn');
        zoomFitBtn = document.getElementById('zoom-fit-btn');
        
        // Canvas
        roiCanvas = document.getElementById('roi-canvas');
        
        if (!form || !submitBtn) {
            console.error('Analysis form not found');
            return false;
        }
        
        return true;
    }
    
    function initializeROISystem() {
        if (!roiCanvas) return;
        
        roiCtx = roiCanvas.getContext('2d');
        
        // Create a hidden image for canvas drawing
        const cellImg = new Image();
        cellImg.crossOrigin = 'anonymous';
        cellImg.onload = function() {
            setupCanvas(this);
        };
        cellImg.src = document.querySelector('#regular-image img').src;
    }
    
    function setupCanvas(img) {
        // Calculate optimal canvas size
        const containerWidth = roiContainer.offsetWidth - 100; // Account for padding
        const maxWidth = Math.min(containerWidth, 600);
        const maxHeight = 500;
        
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        
        // Scale to fit container
        if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
        }
        
        canvasScale = width / img.naturalWidth;
        roiCanvas.width = width;
        roiCanvas.height = height;
        
        // Store reference to image
        roiCanvas.sourceImage = img;
        
        redrawCanvas();
    }
    
    function setupEventListeners() {
        // ROI mode toggle
        if (useROICheckbox) {
            useROICheckbox.addEventListener('change', toggleROIMode);
        }
        
        // Control buttons
        if (addROIBtn) {
            addROIBtn.addEventListener('click', enableDrawingMode);
        }
        
        if (clearROIBtn) {
            clearROIBtn.addEventListener('click', clearAllRegions);
        }
        
        if (zoomFitBtn) {
            zoomFitBtn.addEventListener('click', fitToView);
        }
        
        // Canvas interactions
        if (roiCanvas) {
            roiCanvas.addEventListener('mousedown', startDrawing);
            roiCanvas.addEventListener('mousemove', draw);
            roiCanvas.addEventListener('mouseup', stopDrawing);
            roiCanvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch support for mobile
            roiCanvas.addEventListener('touchstart', handleTouch);
            roiCanvas.addEventListener('touchmove', handleTouch);
            roiCanvas.addEventListener('touchend', stopDrawing);
        }
    }
    
    function toggleROIMode() {
        const isROIMode = useROICheckbox.checked;
        
        if (isROIMode) {
            roiContainer.classList.remove('d-none');
            regularImage.style.display = 'none';
            roiModeIndicator.style.display = 'block';
            
            // Setup canvas if not already done
            if (!roiCanvas.sourceImage) {
                initializeROISystem();
            }
        } else {
            roiContainer.classList.add('d-none');
            regularImage.style.display = 'block';
            roiModeIndicator.style.display = 'none';
            clearAllRegions();
        }
        
        // Trigger custom event
        document.dispatchEvent(new CustomEvent('roiModeChanged', {
            detail: { enabled: isROIMode }
        }));
    }
    
    function enableDrawingMode() {
        isAddingROI = true;
        addROIBtn.classList.add('active');
        addROIBtn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>Drawing Mode';
        roiCanvas.style.cursor = 'crosshair';
        
        const statusEl = document.getElementById('roi-status');
        if (statusEl) {
            statusEl.classList.remove('d-none');
        }
    }
    
    function disableDrawingMode() {
        isAddingROI = false;
        addROIBtn.classList.remove('active');
        addROIBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Add Region';
        roiCanvas.style.cursor = 'default';
        
        const statusEl = document.getElementById('roi-status');
        if (statusEl) {
            statusEl.classList.add('d-none');
        }
    }
    
    function clearAllRegions() {
        roiRegions = [];
        updateROICount();
        disableDrawingMode();
        redrawCanvas();
    }
    
    function fitToView() {
        if (roiCanvas.sourceImage) {
            setupCanvas(roiCanvas.sourceImage);
        }
    }
    
    function getCanvasCoordinates(e) {
        const rect = roiCanvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    function startDrawing(e) {
        if (!isAddingROI) return;
        
        e.preventDefault();
        isDrawing = true;
        
        const coords = getCanvasCoordinates(e);
        startX = coords.x;
        startY = coords.y;
        currentX = startX;
        currentY = startY;
    }
    
    function draw(e) {
        if (!isDrawing || !isAddingROI) return;
        
        e.preventDefault();
        const coords = getCanvasCoordinates(e);
        currentX = coords.x;
        currentY = coords.y;
        
        redrawCanvas();
        
        // Draw current rectangle being drawn
        roiCtx.strokeStyle = '#dc3545';
        roiCtx.lineWidth = 2;
        roiCtx.setLineDash([8, 4]);
        roiCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        roiCtx.setLineDash([]);
    }
    
    function stopDrawing(e) {
        if (!isDrawing || !isAddingROI) return;
        
        isDrawing = false;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        
        // Minimum size validation
        if (width > 15 && height > 15) {
            addROIRegion();
            showRegionAddedFeedback();
        }
        
        disableDrawingMode();
        redrawCanvas();
    }
    
    function addROIRegion() {
        // Scale coordinates to original image size
        const scaleX = roiCanvas.sourceImage.naturalWidth / roiCanvas.width;
        const scaleY = roiCanvas.sourceImage.naturalHeight / roiCanvas.height;
        
        const roi = {
            id: Date.now(),
            x: Math.min(startX, currentX) * scaleX,
            y: Math.min(startY, currentY) * scaleY,
            width: Math.abs(currentX - startX) * scaleX,
            height: Math.abs(currentY - startY) * scaleY
        };
        
        roiRegions.push(roi);
        updateROICount();
        
        console.log('ROI region added:', roi);
    }
    
    function showRegionAddedFeedback() {
        // Visual feedback for region addition
        const feedback = document.createElement('div');
        feedback.className = 'alert alert-success alert-dismissible fade show position-fixed';
        feedback.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        feedback.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Region ${roiRegions.length} added successfully
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            feedback.remove();
        }, 3000);
    }
    
    function redrawCanvas() {
        if (!roiCanvas.sourceImage) return;
        
        roiCtx.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
        roiCtx.drawImage(roiCanvas.sourceImage, 0, 0, roiCanvas.width, roiCanvas.height);
        
        // Draw existing ROI regions
        roiRegions.forEach((roi, index) => {
            drawROIRegion(roi, index);
        });
    }
    
    function drawROIRegion(roi, index) {
        const x = roi.x * canvasScale;
        const y = roi.y * canvasScale;
        const w = roi.width * canvasScale;
        const h = roi.height * canvasScale;
        
        // Fill
        roiCtx.fillStyle = 'rgba(0, 123, 255, 0.15)';
        roiCtx.fillRect(x, y, w, h);
        
        // Border
        roiCtx.strokeStyle = '#007bff';
        roiCtx.lineWidth = 2;
        roiCtx.strokeRect(x, y, w, h);
        
        // Region label
        roiCtx.fillStyle = '#007bff';
        roiCtx.font = 'bold 14px Arial';
        roiCtx.fillText(`${index + 1}`, x + 5, y + 20);
        
        // Corner handles for visual feedback
        drawCornerHandles(x, y, w, h);
    }
    
    function drawCornerHandles(x, y, w, h) {
        roiCtx.fillStyle = '#007bff';
        const handleSize = 6;
        
        // Corner squares
        roiCtx.fillRect(x - handleSize/2, y - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x + w - handleSize/2, y - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x - handleSize/2, y + h - handleSize/2, handleSize, handleSize);
        roiCtx.fillRect(x + w - handleSize/2, y + h - handleSize/2, handleSize, handleSize);
    }
    
    function updateROICount() {
        const countElement = document.getElementById('roi-count');
        if (countElement) {
            countElement.textContent = roiRegions.length;
        }
        
        // Update button states
        if (clearROIBtn) {
            clearROIBtn.disabled = roiRegions.length === 0;
        }
    }
    
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type.replace('touch', 'mouse'), {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        roiCanvas.dispatchEvent(mouseEvent);
    }
    
    function setupFormHandling() {
        if (!form || !submitBtn) return;
        
        form.addEventListener('submit', function(e) {
            const analysisStatus = document.getElementById('analysis-status');
            
            // ROI validation
            if (useROICheckbox && useROICheckbox.checked) {
                if (roiRegions.length === 0) {
                    e.preventDefault();
                    showROIValidationError();
                    return false;
                }
                
                // Add ROI data to form
                addROIDataToForm();
            }
            
            // Show processing state
            submitBtn.disabled = true;
            submitBtn.value = 'Processing...';
            
            if (analysisStatus) {
                analysisStatus.classList.remove('d-none');
            }
            
            // Progressive feedback
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.value = 'Analyzing cells...';
                }
            }, 2000);
        });
    }
    
    function addROIDataToForm() {
        // Remove existing ROI inputs
        const existingInputs = form.querySelectorAll('input[name="roi_data"], input[name="roi_count"]');
        existingInputs.forEach(input => input.remove());
        
        // Add new ROI data
        const roiInput = document.createElement('input');
        roiInput.type = 'hidden';
        roiInput.name = 'roi_data';
        roiInput.value = JSON.stringify(roiRegions);
        form.appendChild(roiInput);
        
        const roiCountInput = document.createElement('input');
        roiCountInput.type = 'hidden';
        roiCountInput.name = 'roi_count';
        roiCountInput.value = roiRegions.length;
        form.appendChild(roiCountInput);
        
        console.log(`Added ${roiRegions.length} ROI regions to form`);
    }
    
    function showROIValidationError() {
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ROI Selection Required
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>ROI selection is enabled but no regions have been drawn.</p>
                        <p><strong>Please either:</strong></p>
                        <ol>
                            <li>Click "Add Region" and draw rectangles around cell areas</li>
                            <li>Or uncheck "Use ROI Selection" to analyze the entire image</li>
                        </ol>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="fas fa-check me-1"></i>
                            Got it
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
    }
    
    // Image fullscreen functionality
    window.toggleImageFullscreen = function(img) {
        if (!img) return;
        
        if (img.style.position === 'fixed') {
            // Exit fullscreen
            img.style.cssText = '';
            img.classList.remove('img-fullscreen');
        } else {
            // Enter fullscreen
            img.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                object-fit: contain;
                background: rgba(0,0,0,0.9);
                z-index: 9999;
                cursor: zoom-out;
            `;
            img.classList.add('img-fullscreen');
            
            img.addEventListener('click', function() {
                toggleImageFullscreen(this);
            }, { once: true });
        }
    };
    
})();
</script>
{% endblock %}
{% endblock %}